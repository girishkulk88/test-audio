<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />

    <title>Podcast simple demo</title>
  </head>

  <body>
    <h1>Podcast simple demo</h1>

    <input
      class="playback-position-control"
      type="range"
      min="0.0"
      max="3600"
      step="0.05"
      value="0"
    />
    <span class="playback-position-value">1.0</span>
    <br/>
    <label class="curpos">0 seconds</label>
    <br/>
    <button class="play">Play</button>
    <button class="stop">Stop</button>
    <button class="pause"><span>Pause</span></button>
    <br/>
    <button class="rew"><span>-15</span></button>
    <button class="ff"><span>+15</span></button>


    <h2>Volume controls</h2>
    <h3>Main track</h3>
    <input
            type="range"
            id="volumeControlm"
            class="control-volumem"
            min="0"
            max="2"
            value="1"
            step="0.01"
          />
    <h3>Overlay</h3>
    <input
            type="range"
            id="volumeControlo"
            class="control-volumeo"
            min="0"
            max="2"
            value="1"
            step="0.01"
          />


    <h2>Set playback rate</h2>
    <input
      class="playback-rate-control"
      type="range"
      min="0.25"
      max="3"
      step="0.05"
      value="1"
    />
    <span class="playback-rate-value">1.0</span>


  </body>
  <script>
    // define variables
    let audioCtx;
    let source;
    let songLength;
    let gainL;
    let gainR;
    let paused;
    let mybuffer;
    let startTime;
    let splitter;
    let merger;
    let playback;
    let playbackText;
    let playBackPosOff;
    let curpos;
    let playing;

    const play = document.querySelector(".play");
    const stop = document.querySelector(".stop");
    const ff = document.querySelector(".ff");
    const rew = document.querySelector(".rew");
    const pause = document.querySelector(".pause");
    playbackText = document.querySelector(".playback-position-value");
    playback = document.querySelector(".playback-position-control");
    curpos = document.querySelector(".curpos");
    playing=false;
    const playbackControl = document.querySelector(".playback-rate-control");
    const playbackValue = document.querySelector(".playback-rate-value");
    playbackControl.setAttribute("disabled", "disabled");


    function update_pos() {
         if (playing)
         {
             playback.value=audioCtx.currentTime+playbackPosOff;
             curpos.textContent=Math.floor(playback.value) + ' seconds';
             pos_update_timer();
         }
    }

    function pos_update_timer(){
    var refresh=1000; // Refresh rate in milli seconds
    mytime=setTimeout('update_pos()',refresh)
    }

    function getData() {
      audioCtx = new AudioContext();
      source = new AudioBufferSourceNode(audioCtx);
      request = new XMLHttpRequest();

      request.open("GET", "chaturanga.mp3", true);

      request.responseType = "arraybuffer";

      request.onload = () => {
        let audioData = request.response;

        audioCtx.decodeAudioData(
          audioData,
          (buffer) => {
            songLength = buffer.duration;
            playbackText.textContent=Math.floor(songLength) + ' seconds';
            playback.setAttribute("max", Math.floor(songLength));
            source.buffer = buffer;
            mybuffer = buffer;
            source.playbackRate.value = playbackControl.value;

            splitter = audioCtx.createChannelSplitter(2);
            source.connect(splitter);
            merger = audioCtx.createChannelMerger(2);
            merger.connect(audioCtx.destination);
//            console.log('length: ' + songLength);
            gainL = audioCtx.createGain();
            gainR = audioCtx.createGain();


            splitter.connect(gainL, 0, 0);
            splitter.connect(gainR, 1, 0);


            gainL.connect(merger, 0, 0);
            gainR.connect(merger, 0, 1);
            gainL.gain.value = 1;
            gainR.gain.value = 1;


          },
          (e) => {
            `Error with decoding audio data ${e.error}`;
          }
        );
      };

      request.send();
    }

    // wire up buttons to stop and play audio, and range slider control

    play.onclick = () => {
      getData();
      startTime=0;
      playbackPosOff=0;
      playing=true;
      source.start(startTime);
      startTime=audioCtx.currentTime;
//      console.log('Saved startTime: ' + startTime);
      paused=false;
      play.setAttribute("disabled", "disabled");
      playbackControl.removeAttribute("disabled");
      pos_update_timer();
    };


    pause.onclick = () => {
//      console.log('currentTime: ' + audioCtx.currentTime);
      if (paused==true)
      {
      paused=false;
      pause.textContent="Pause";
//      console.log('ct on resume: ' + audioCtx.currentTime);
      audioCtx.resume();
      }
      else
      {
      paused=true;
      pause.textContent="Resume";
//      console.log('ct on pause: ' + audioCtx.currentTime);
      audioCtx.suspend();
      }
    };
    stop.onclick = () => {
//      console.log('currentTime: ' + audioCtx.currentTime);
      source.stop(0);
      playing=false;
      play.removeAttribute("disabled");
      playbackControl.setAttribute("disabled", "disabled");
    };

    ff.onclick = () => {
      const currentTime=audioCtx.currentTime;
      source.stop(currentTime);
      source.disconnect();
      source = audioCtx.createBufferSource();
      source.buffer = mybuffer;
      source.connect(splitter);
      merger.connect(audioCtx.destination);
      playbackPosOff +=15;
//      console.log('ct:' + currentTime + ' playbackPosOff: ' + playbackPosOff);
      source.start(0,currentTime + playbackPosOff);
    };

    rew.onclick = () => {
      const currentTime=audioCtx.currentTime;
      source.stop(currentTime);
      source.disconnect();
      source = audioCtx.createBufferSource();
      source.buffer = mybuffer;
      source.connect(splitter);
      merger.connect(audioCtx.destination);
      playbackPosOff -=15;
//      console.log('ct:' + currentTime + ' playbackPosOff: ' + playbackPosOff);
      source.start(0,currentTime + playbackPosOff);
    };

    playback.oninput = () => {
      const currentTime=audioCtx.currentTime;
      source.stop();
      source.disconnect();
      source = audioCtx.createBufferSource();
      source.buffer = mybuffer;
      source.connect(splitter);
      merger.connect(audioCtx.destination);
//      console.log('playback pos: ' + playback.value + ' currentTime: ' + audioCtx.currentTime);
      playbackPosOff = playback.value-currentTime;
      source.start(0,playback.value);
    };

    playbackControl.oninput = () => {
      source.playbackRate.value = playbackControl.value;
      playbackValue.textContent = playbackControl.value;
    };

    volumeControlm.oninput = () => {
                  gainL.gain.value=volumeControlm.value;
   }
    volumeControlo.oninput = () => {
                  gainR.gain.value=volumeControlo.value;
   }
  </script>
</html>
