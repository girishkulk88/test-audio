<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width" />

    <title>Podcast simple demo</title>
  </head>

  <body>
    <h1>Podcast simple demo</h1>

    <button class="play">Play</button>
    <button class="stop">Stop</button>
    <button class="pause"><span>Pause</span></button>
    <br/>
    <button class="rew"><span>rew</span></button>
    <button class="ff"><span>ff</span></button>


    <h2>Volume controls</h2>
    <h3>Main track</h3>
    <input
            type="range"
            id="volumeControlm"
            class="control-volumem"
            min="0"
            max="2"
            value="1"
            step="0.01"
          />
    <h3>Overlay</h3>
    <input
            type="range"
            id="volumeControlo"
            class="control-volumeo"
            min="0"
            max="2"
            value="1"
            step="0.01"
          />


    <h2>Set playback rate</h2>
    <input
      class="playback-rate-control"
      type="range"
      min="0.25"
      max="3"
      step="0.05"
      value="1"
    />
    <span class="playback-rate-value">1.0</span>

    <!--
    <h2>Set loop start and loop end</h2>
    <input
      class="loopstart-control"
      type="range"
      min="0"
      max="20"
      step="1"
      value="0"
    />
    <span class="loopstart-value">0</span>

    <input
      class="loopend-control"
      type="range"
      min="0"
      max="20"
      step="1"
      value="0"
    />
    <span class="loopend-value">0</span>
    -->

  </body>
  <script>
    // define variables
    let audioCtx;
    let source;
    let songLength;
    let gainL;
    let gainR;
    let paused;
    let mybuffer;
    let startTime;

    const play = document.querySelector(".play");
    const stop = document.querySelector(".stop");
    const ff = document.querySelector(".ff");
    const rew = document.querySelector(".rew");
    const pause = document.querySelector(".pause");

    const playbackControl = document.querySelector(".playback-rate-control");
    const playbackValue = document.querySelector(".playback-rate-value");
    playbackControl.setAttribute("disabled", "disabled");

    /*
    const loopstartControl = document.querySelector(".loopstart-control");
    const loopstartValue = document.querySelector(".loopstart-value");
    loopstartControl.setAttribute("disabled", "disabled");

    const loopendControl = document.querySelector(".loopend-control");
    const loopendValue = document.querySelector(".loopend-value");
    loopendControl.setAttribute("disabled", "disabled");
    */

    // use XHR to load an audio track, and
    // decodeAudioData to decode it and stick it in a buffer.
    // Then we put the buffer into the source

    function getData() {
      audioCtx = new AudioContext();
      source = new AudioBufferSourceNode(audioCtx);
      request = new XMLHttpRequest();

      request.open("GET", "chaturanga.mp3", true);

      request.responseType = "arraybuffer";

      request.onload = () => {
        let audioData = request.response;

        audioCtx.decodeAudioData(
          audioData,
          (buffer) => {
            songLength = buffer.duration;
            source.buffer = buffer;
            mybuffer = buffer;
            source.playbackRate.value = playbackControl.value;

            const splitter = audioCtx.createChannelSplitter(2);
            source.connect(splitter);
            const merger = audioCtx.createChannelMerger(2);
            merger.connect(audioCtx.destination);
            console.log('length: ' + songLength);
            gainL = audioCtx.createGain();
            gainR = audioCtx.createGain();


            splitter.connect(gainL, 0, 0);
            splitter.connect(gainR, 1, 0);


            gainL.connect(merger, 0, 0);
            gainR.connect(merger, 0, 1);
            gainL.gain.value = 1;
            gainR.gain.value = 1;

//            source.loop = true;

//            loopstartControl.setAttribute("max", Math.floor(songLength));
//            loopendControl.setAttribute("max", Math.floor(songLength));
          },
          (e) => {
            `Error with decoding audio data ${e.error}`;
          }
        );
      };

      request.send();
    }

    // wire up buttons to stop and play audio, and range slider control

    play.onclick = () => {
      getData();
      startTime=0;
      source.start(startTime);
      startTime=audioCtx.currentTime;
      console.log('Saved startTime: ' + startTime);
      paused=false;
      play.setAttribute("disabled", "disabled");
      playbackControl.removeAttribute("disabled");
//      loopstartControl.removeAttribute("disabled");
//      loopendControl.removeAttribute("disabled");
    };



    pause.onclick = () => {
//      console.log('currentTime: ' + audioCtx.currentTime);
      if (paused==true)
      {
      paused=false;
      pause.textContent="Pause";
      audioCtx.resume();
      }
      else
      {
      paused=true;
      pause.textContent="Resume";
      audioCtx.suspend();
      }
    };
    stop.onclick = () => {
//      console.log('currentTime: ' + audioCtx.currentTime);
      source.stop(0);
      play.removeAttribute("disabled");
      playbackControl.setAttribute("disabled", "disabled");
//      loopstartControl.setAttribute("disabled", "disabled");
//      loopendControl.setAttribute("disabled", "disabled");
    };

    ff.onclick = () => {
      const currentTime=audioCtx.currentTime;
      source.stop(currentTime);
      source.disconnect();
      source = audioCtx.createBufferSource();
      source.buffer = mybuffer;
      source.connect(audioCtx.destination);
      console.log('ct:' + currentTime + ' startTime: ' + startTime + ' offset: ' + (currentTime-startTime+15));
      source.start(currentTime, currentTime - startTime + 15);
//      source.start(currentTime, 15);
      startTime-=15;
    };

    rew.onclick = () => {
      const currentTime=audioCtx.currentTime;
      source.stop(currentTime);
      source.disconnect();
      source = audioCtx.createBufferSource();
      source.buffer = mybuffer;
      source.connect(audioCtx.destination);
      console.log('ct:' + currentTime + ' startTime: ' + startTime);
      source.start(currentTime, currentTime - startTime + 15);
      startTime+=15;
    };

    playbackControl.oninput = () => {
      source.playbackRate.value = playbackControl.value;
      playbackValue.textContent = playbackControl.value;
    };

    volumeControlm.oninput = () => {
                  gainL.gain.value=volumeControlm.value;
   }
    volumeControlo.oninput = () => {
                  gainR.gain.value=volumeControlo.value;
   }
/*
    loopstartControl.oninput = () => {
      source.loopStart = loopstartControl.value;
      loopstartValue.textContent = loopstartControl.value;
    };

    loopendControl.oninput = () => {
      source.loopEnd = loopendControl.value;
      loopendValue.textContent = loopendControl.value;
    };
*/
  </script>
</html>
